# Taxi-Multiagent-System

# Πρόβλημα

Στην παρούσα εργασία, έχουμε έναν πράκτορα taxi που μετακινείται σε έναν κόσμο 5x5 και σκοπός του είναι να εξυπηρετήσει τους πελάτες. Υπάρχουν 4 διακριτές θέσεις: η κόκκινη (R), η μπλε (B), η πράσινη (G) και η κίτρινη (Y). Επίσης, υπάρχουν διάφοροι τοίχοι σε αυτόν τον κόσμο, οι οποίοι είναι αρχικά άγνωστοι στον πράκτορα. Οι πελάτες θα εμφανίζονται τυχαία σε μία από τις διακριτές θέσεις και θέλουν να μεταβούν σε μία άλλη. Ο πράκτορας πρέπει να μεταβεί στην θέση του πελάτη, να τον φορτώσει, να τον πάει στην τελική του θέση και να τον εκφορτώσει.

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/21b93b9e-713f-4e71-b739-cfef3ec7ade8)

Σε κάθε επεισόδιο ο πράκτορας ξεκινάει από μια τυχαία θέση στον κόσμο. Ένα επεισόδιο ορίζεται από μία μεταβλητή, την maxActions, η οποία καθορίζει πόσες ενέργειες μπορεί να κάνει ο πράκτορας μέχρι να τελειώσει το επεισόδιο. Όταν τελειώσει το επεισόδιο, δηλαδή το maxActions γίνει 0, τότε ο αλγόριθμος ξεκινάει από την αρχή, όλα τα intentions και τα beliefs του πράκτορα διαγράφονται και ο πράκτορας είναι έτοιμος να εξυπηρετήσει τους πελάτες που θα εμφανιστούν.

Ο πράκτορας θα πρέπει να πραγματοποιεί τις ακόλουθες ενέργειες με κόστος -1 για κάθε ενέργεια: (α) φόρτωση πελάτη, (β) εκφόρτωση πελάτη, (γ) κίνηση στο επόμενο τετράγωνο επάνω, (δ) κάτω, (ε) δεξιά, (ζ) αριστερά. Αυτός θα λαμβάνει ανταμοιβή +20 κάθε φορά που εκφορτώνει κάποιον πελάτη επιτυχώς, ενώ έχει ένα κόστος -10 αν προσπαθήσει να φορτώσει ή εκφορτώσει τον πελάτη από/σε λάθος θέση και κόστος -100 αν προσκρούσει σε τοίχο.

# Πολυπρακτορικό Σύστημα 

Στο 2ο μέρος της εργασίας δημιουργούμε ένα πολυπρακτορικό σύστημα στο ίδιο περιβάλλον και με τους ίδιους κανόνες. Συνεπώς, έχουμε δύο πράκτορες-ταξί που επικοινωνούν μεταξύ τους και «μοιράζουν» τους πελάτες που θα εξυπηρετήσουν. Σκοπός των πρακτόρων είναι να μεγιστοποιήσουν το συνολικό reward.

Οι πράκτορες λαμβάνουν κλήσεις για πελάτες που περιμένουν να εξυπηρετηθούν. Μετά υπολογίζουν την συνολική απόσταση της διαδρομής. Η τιμή αυτή θα είναι και η προσφορά τους. Ο πράκτορας-ταξί με την μικρότερη προσφορά θα κερδίσει την δημοπρασία και θα αναλάβει τον πελάτη.

# Αρχιτεκτονική Πρακτόρων 

Beliefs 

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/97a913b5-7622-470b-aee6-3f1749782d72)


• at(O,C,R): Αυτό σημαίνει ότι το αντικείμενο Ο βρίσκεται στην στήλη C και γραμμή R. To O παίρνει τιμές {taxi, client} ενώ τα C και R παίρνουν τιμές στο διάστημα [0, 4].

• drop(client,C,R): Χρησιμοποιούμε αυτό το κατηγόρημα για να υποδηλώσουμε την θέση στην οποία θέλει να πάει ο πελάτης. Ομοίως με παραπάνω τα C και R παίρνουν τιμές στο διάστημα [0, 4].

• serving(taxi): To κατηγόρημα αυτό υποδηλώνει ότι ο πράκτορας taxi εξυπηρετεί κάποιον πελάτη.

• hasReached(maxActions): Το κατηγόρημα αυτό υποδηλώνει ότι ο πράκτορας έχει πραγματοποιήσει τον μέγιστό αριθμό ενεργειών για αυτό το επεισόδιο.

• cnp(Id,At,Drop): Αυτό σημαίνει ότι ο πράκτορας είναι υπεύθυνος να τρέξει ένα cnp πρωτόκολλο. Το id είναι το id του πρωτοκόλλου το οποίο ταυτίζεται με το id του πελάτη για τον οποίο γίνεται το πρωτόκολλο. Τα at και drop είναι τα κατηγορήματα που έχουν ήδη ορισθεί, δηλαδή at(client,C,R) και drop(client,C,R) και παίρνουν τιμές ανάλογα με τον πελάτη.

• price(CNPId, Offer): Αποτυπώνει την προσφορά που κάνει ένας πράκτορας για τον πελάτη CNPId. To offer είναι η συνολική απόσταση της διαδρομής προκειμένου να εξυπηρετηθεί ο πελάτης.

• isAvailable(taxi): Υποδηλώνει ότι πράκτορας είναι διαθέσιμος ή αν εξυπηρετεί κάποιον πελάτη.

• doingCNP: Υποδηλώνει ότι μία δημοπρασία (cnp) είναι σε εξέλιξη.

• notDoingCNP: Υποδηλώνει ότι δεν υπάρχει δημοπρασία (cnp) σε εξέλιξη.

• cfp(CNPId, At, Drop): Αυτό σημαίνει ότι ο πράκτορας έχει λάβει ένα call for proposal, δηλαδή να κάνει κάποια προσφορά σε μία δημοπρασία. Το CNPId είναι το id της δημοπρασίας και τα at και drop, τα at(client,C,R) και drop(client,C,R) και παίρνουν τιμές ανάλογα με τον πελάτη.

• proposal(CNPId, At, Drop, Offer): Αυτό σημαίνει ότι ο πράκτορας έχει κάνει μία προσφορά στην δημοπρασία CNPId. H αξία αυτής της προσφοράς είναι το offer το οποίο είναι η συνολική απόσταση διαδρομής. Τα at και drop, τα at(client,C,R) και drop(client,C,R) και παίρνουν τιμές ανάλογα με τον πελάτη.

• propose(CNPId,Offer): Αυτό σημαίνει ότι ο πράκτορας έχει λάβει μία προσφορά για την δημοπρασία CNPId. H αξία αυτής της προσφοράς είναι το offer το οποίο είναι η συνολική απόσταση διαδρομής.

• refuse(CNPId): Αυτό σημαίνει ότι ο πράκτορας έχει λάβει μία άρνηση προσφοράς για την δημοπρασία CNPId.

• accept_proposal(CNPId, At, Drop): Αυτό σημαίνει ότι ο πράκτορας κέρδισε την δημοπρασία CNPId. Τα at και drop, τα at(client,C,R) και drop(client,C,R) και παίρνουν τιμές ανάλογα με τον πελάτη.

• reject_proposal(CNPId,At,Drop): Αυτό σημαίνει ότι ο πράκτορας έχασε την δημοπρασία CNPId. Τα at και drop, τα at(client,C,R) και drop(client,C,R) και παίρνουν τιμές ανάλογα με τον πελάτη.


Ενέργειες 

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/c85fcffa-613d-4a7d-96d4-78f823527175)


• checkForClient: O πράκτορας ελέγχει αν υπάρχει κάποιος πελάτης στο grid. Η ενέργεια αυτή δεν επιφέρει κάποια αλλαγή στο περιβάλλον. Είναι βοηθητική και ο πράκτορας θα κάνει αυτή την ενέργεια μέχρι να εμφανιστεί κάποιος πελάτης.

• chooseClient: O πράκτορας επιλέγει ποιον πελάτη θα εξυπηρετήσει.

• moveTowards(C,R): Ο πράκτορας κινείται προς την θέση (C, R).

• loadClient(C,R): O πράκτορας φορτώνει τον πελάτη στην θέση (C, R).

• unloadClient(C,R): O πράκτορας εκφορτώνει τον πελάτη στην θέση (C, R).

Στην συνέχεια ορίσαμε και την ενέργεια updateSelf(CNPId,At,Drop) με την οποία ο πράκτορας ορίζει με βάση τα ορίσματα της ενέργειας μερικές από τις μεταβλητές του που είναι απαραίτητες για την κίνησή του. 

Έχοντας ορίσει τα κατηγορήματα και τις ενέργειες μπορούμε να υλοποιήσουμε και τα πλάνα των πρακτόρων.

Οι πράκτορές μας ξεκινάνε πάντα έχοντας ως στόχο το check. O στόχος αυτός είναι επαναληπτικός. Σε περίπτωση που ο πράκτοράς μας δεν έχει το belief not cnp(Id,At,Drop) και not serving(taxi), τότε θα κάνει την ενέργεια checkForClient και αφού την πραγματοποιήσει θα ξαναπροσθέσει τον στόχο check στα intentions του.

Το περιβάλλον είναι υπεύθυνο για την ανάθεση ενός cnp πρωτοκόλλου για έναν πελάτη σε κάποιον από τους πράκτορες. Πάντα αναθέτει έναν πελάτη την φορά σε κάποιον πράκτορα και μόλις ολοκληρωθεί το πρωτόκολλο, αναθέτει τον επόμενο σε κάποιον πράκτορα.

Την στιγμή που προστεθεί το belief cnp(CNPId,At,Drop) σε κάποιον πράκτορα τότε αυτός θα προσθέσει ως στόχο να διεκπεραιώσει αυτό το πρωτόκολλο.
Τα βήματα του initiateCNP(Id,At,Drop) είναι τα ακόλουθα:
1. +doingCNP, όπου ο πράκτορας προσθέτει αυτό το belief, εμποδίζοντας έτσι την διεκπεραίωση κάποιου άλλου CNP.
2. +cnp(Id,At,Drop), όπου ο πράκτορας προσθέτει το cnp στα beliefs του (εδώ η πηγή είναι ο εαυτός του, ενώ πριν ήταν το περιβάλλον).
3. !call(Id,At,Drop,LP), όπου ο πράκτορας προσθέτει ως στόχο να ζητήσει από όλους τους πράκτορες κάποια προσφορά για αυτόν τον πελάτη.
4. !bid(Id,LP), όπου ο πράκτορας περιμένει μέχρι οι πράκτορες να του στείλουν τις προσφορές τους.
5. !winner(Id,LO,Wag), όπου ο πράκτορας συγκρίνει τις προσφορές και βρίσκει τον νικητή της δημοπρασίας.
6. !result(Id,LO,Wag,At,Drop), όπου ο πράκτορας ανακοινώνει σε όλους τους πράκτορες τα αποτελέσματα τις δημοπρασίας.
7. +cnp(Id,At,Drop), όπου ο πράκτορας αφαιρεί το cnp στα beliefs του.
   
Στο σημείο αυτό καλό είναι να τονίσουμε τον ρόλο του doingCNP. To belief αυτό λειτουργεί ως φρουρός προκειμένου να αποτρέψει δύο ή περισσότερα πρωτόκολλα να τρέξουν ταυτόχρονα. Σε περίπτωση που γίνει αυτό υπάρχει ο κίνδυνος, να μην έχουν ανακοινωθεί τα αποτελέσματα της πρώτης δημοπρασίας, και επομένως οι πράκτορες να κάνουν και άλλη προσφορά ακόμα και αν έχουν κερδίσει. Επομένως σε περίπτωση που υπάρχει το doingCNP, ο πράκτορας περιμένει λίγο και ξαναπροσπαθεί αργότερα, μέχρι να μην ισχύει αυτό.

Συνεχίζοντας με το cnp πρωτόκολλο, ας δούμε λίγο το call. Ο πράκτορας ενημερώνει αρχικά όλους τους πράκτορες ότι κάνει δημοπρασία (δηλαδή στέλνει το doingCNP) και έπειτα τους στέλνει ένα call for proposal (cfp(Id,At,Drop) προκειμένου να κάνουν κάποια προσφορά.

Όταν κάποιος πράκτορας λάβει ένα cfp(Id,At,Drop) τότε αναλόγως με την κατάσταση στην οποία βρίσκεται θα δώσει την κατάλληλη απάντηση. Στην περίπτωση που είναι διαθέσιμος (isAvailable(taxi)), θα κάνει μία προσφορά προσθέτοντας τον στόχο !makeOffer(CNPId,At,Drop) ώστε να καλέσει την ενέργεια chooseClient(CNPId,At,Drop). Εκτελώντας αυτή την ενέργεια, θα του προστεθεί ένα belief price(CNPId,Offer), όπου το offer είναι η συνολική απόσταση της διαδρομής. Έπειτα θα προσθέσει αυτή την πρόταση στα beliefs του και θα στείλει στον initiator, σε αυτόν δηλαδή που τρέχει το πρωτόκολλο,
την πρότασή του (propose(CNPId,Offer)). Στην περίπτωση που δεν είναι διαθέσιμος και εξυπηρετεί κάποιον πελάτη, απλά στέλνει refuse(CNPId) στον initiator.

Αφού λοιπόν λάβει όλες τις απαντήσεις από τους πράκτορες, ο initiator, θα βρει τον νικητή κάνοντας τον στόχο winner(Id,LO,WAg). O πράκτορας θα βρει εκείνη την προσφορά με την χαμηλότερη τίμη, δηλαδή χαμηλότερη απόσταση. Στην περίπτωση που δεν έχει λάβει κάποια απάντηση ή έχει λάβει μόνο refuse τότε θα λήξει την δημοπρασία, θα αφαιρέσει από τα beliefs του τις απαντήσεις των πρακτόρων, θα περιμένει λίγο και ύστερα θα ξανατρέξει την ίδια δημοπρασία.

Μόλις βρεί τον νικητή, θα ανακοινώσει τα αποτελέσματα της δημοπρασίας με τον στόχο result(CNPId,_,_At,Drop). Αρχικά θα στείλει το αποτέλεσμα στον νικητή και ότι αποδέχεται την προσφορά του (accept_proposal(CNPId,At,Drop)) και στην συνέχεια στους υπόλοιπους ότι απορρίπτει την προσφορά τους (reject_proposal(CNPId,At,Drop)). Παράλληλα ενημερώνει όλους τους πράκτορες ότι η δημοπρασία έληξε (notDoingCNP).

O νικητής της δημοπρασίας πλέον δεν θα είναι διαθέσιμος και θα καλέσει την updateSelf(CNPId,At,Drop). Με βάση τα ορίσματα αυτής της ενέργειας, θα ενημερώσει κάποιες μεταβλητές του ώστε να είναι έτοιμος να εξυπηρετήσει τον πελάτη. Στην συνέχεια προσθέτει το serving(taxi) στα beliefs του.

Η διαδικασία της κίνησης και της εξυπηρέτησης του πελάτη είναι ίδια με αυτήν που περιγράφθηκε στο μονοπρακτορικό σύστημα.

Παρακάτω βλέπουμε την αρχιτεκτονική της επικοινωνίας από πλευράς initiator.

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/4fd39ed1-d9bd-487d-a554-18f261a23fb6)

Και εδώ βλέπουμε την αρχιτεκτονική της επικοινωνίας από πλευράς bidder. 

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/7a38ab8d-95a2-443c-a4c8-c96eb811c9cc) 

Προκειμένου να γίνει πιο εύκολη η διαχείριση της γνώσης των πρακτόρων, δηλαδή των μεταβλητών που έχουν, αντί να είναι μαζεμένη στο TaxiModel, δημιουργήσαμε την κλάση TaxiAgent στην οποία αποθηκεύομε εκεί όλες τις απαραίτητες μεταβλητές για τον κάθε πράκτορα. Επομένως για κάθε πράκτορα στο σύστημα έχουμε και από ένα instance του TaxiAgent.

Παρακάτω βλέπουμε το MVC diagram με την προσθήκη της TaxiAgent. 

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/a2883c68-e066-4e56-a152-22b4c2c42734)

Η παραπάνω διαδικασία γίνεται επαναληπτικά μέχρι να τελειώσει το επεισόδιο, όπου όλα θα ξαναξεκινήσουν από την αρχή, εκτός βέβαια από την γνώση των πρακτόρων σχετικά με τους τοίχους του περιβάλλοντος. Έτσι ενώ στην αρχή θα παίρνουν ένα πολύ χαμηλό reward, κατά την πάροδο των επεισοδίων το reward θα αυξάνεται.

Παρακάτω βλέπουμε δύο γραφήματα με το πως κινείται το reward που έχουν πάρει οι πράκτορες κατά την πάροδο 6 επεισοδίων. Στο πρώτο γράφημα το επεισόδιο ήταν 40 ενεργειών χωρίς όμως να μοιράζονται τις γνώσεις τους σχετικά με το περιβάλλον, ενώ στο δεύτερο ήταν 40 ενεργειών μοιράζοντας όμως τις γνώσεις τους. Για να έχουμε μια πληρέστερη εικόνα τρέξαμε το πρόγραμμα δύο φορές.

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/db6a8a20-e99e-417b-a149-4c76cc7f9f83)

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/ca201271-eb57-48f8-9b60-53cb0048c53d)

Βλέπουμε λοιπόν πόσο σημαντικά αυξάνεται το reward στην περίπτωση που οι δύο πράκτορες επικοινωνούν μεταξύ τους. Επιπλέον μπορούμε να καταλήξουμε στο συμπέρασμα ότι το πολυπρακτορικό σύστημα είναι αρκετά καλύτερο από το μονοπρακτορικό καθώς το περιβάλλον μαθαίνεται πιο γρήγορα και έτσι το συνολικό reward που παίρνουν οι πράκτορες είναι μεγαλύτερο.

# Παράδειγμα Εκτέλεσης 

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/08ed4abe-bca9-44e6-a840-4360ff1f52d9)

Το σύστημα ξεκινάει και οι πράκτορες ψάχνουν πελάτες στο περιβάλλον. Εμφανίζονται 2 πελάτες, ο πρώτος βρίσκεται στην θέση Yellow (0,4) και θέλει να πάει στην θέση Yellow, ενώ ο δεύτερος βρίσκεται στην θέση Blue (3,4) και θέλει να πάει στην θέση Green (4,0).

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/9b1e8198-407f-4daa-b7bb-b9ed66280c38)

Ξεκινάει η δημοπρασία για τον 1ο πελάτη την οποία αναλαμβάνει ο taxi1. Οι πράκτορες κάνουν τις προσφορές τους και περιμένουν.

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/b5949ed1-634b-460c-8c5e-087c0ab4cce5)

Ο πράκτορας taxi1 είχε την μικρότερη προσφορά και αναλαμβάνει να εξυπηρετήσει τον πελάτη.

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/38b54cb0-4047-43ef-8125-30fc19ea06ae)

Ξεκινάει και η δημοπρασία για τον 2ο πελάτη την οποία πάλι αναλαμβάνει ο taxi1. Αυτή τη φορά κάνει προσφορά μόνο το taxi2, καθώς ο taxi1 δεν είναι διαθέσιμος γιατί εξυπηρετεί άλλον πελάτη.

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/08e93867-0ccc-4f15-937d-2301f318f666)

Ο taxi2 κερδίζει τη δημοπρασία ενώ παράλληλα δημιουργείται και άλλος πελάτης.

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/360d5290-306a-48ac-b5fa-750a0d8b7f1b) 

Η δημοπρασία για τον 3ο πελάτη ξεκινάει αλλά επειδή κανένας πράκτορας δεν είναι διαθέσιμος, δεν θα υπάρχουν προσφορές και θα προσπαθεί μέχρι κάποιος πράκτορας να είναι διαθέσιμος.

Εδώ να σημειώσουμε, ότι τυχόν άλλοι πελάτες που θα εμφανιστούν και δεν θα έχει ολοκληρωθεί αυτή η δημοπρασία, θα μπουν σε ουρά αναμονής και θα κληθούν σε δημοπρασία με σειρά εμφάνισης (FIFO).

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/3737dd9b-9131-4261-8efd-9744d90a3e94)

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/76a87b7f-8f03-429c-a33d-2c4a6bc8ff39)

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/69caf624-98e0-43e3-b219-2f6475cf7944)

Ο taxi1 ολοκλήρωσε έφτασε στον στόχο του και έκανε unload τον πελάτη.

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/b329f36c-8fa5-47c2-833d-eee262f5effc)

![image](https://github.com/MagdaToma8/Taxi-Multiagent-System/assets/128919446/85bafe3c-f326-4582-b632-ae7806a3b334)

Επομένως, όταν ξανά γίνεται η δημοπρασία για τον 3ο πελάτη, ο taxi1 είναι διαθέσιμος και κάνει προσφορά και τον αναλαμβάνει.



